<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

    <title>mogilefs fsck探究</title>
    <meta name="description" content="">

    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
  </head>
  <body>
    <aside id="sidebar">
      <nav id="tags">
        <a href="/index.html" id="avatar"></a>

        <ul id="tags__ul">
          <li id="js-label1" class="tags__li tags-btn active">所有文章</li>
          <li id="js-label2" class="tags__li tags-btn">后端</li>
          <li id="js-label3" class="tags__li tags-btn">移动</li>
          <li id="js-label4" class="tags__li tags-btn">前端</li>
          <li id="js-label5" class="tags__li tags-btn">系统</li>
          <li id="js-label6" class="tags__li tags-btn">数据存储</li>
        </ul>

        <div id="tags__bottom">
          <a href="mailto:wanghuida258@aliyun.com" id="icon-email" class="tags-btn fontello"></a>
          <a href="/rss.xml" id="icon-feed" class="tags-btn fontello"></a>
        </div>
      </nav> <!-- end #tags -->

      <div id="posts-list">
        <!--<form action="" id="search-form">
          <a href="/index.html" id="mobile-avatar"></a>
          NOTE: input field is disabled by default 
          <input id="search-input" type="text" placeholder="Search..." disabled >
        </form>-->

        <nav id="pl__container">
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/09/30/web-get-ios-device-id.html"><span class="pl__circle"></span><span class="pl__title">web 取得ios设备的DeviceId</span><span class="pl__date">Sep 2014</span></a>
        
          <a class="前段 pl__all" href="/%E5%89%8D%E6%AE%B5/2014/09/30/velocity-intro.html"><span class="pl__circle"></span><span class="pl__title">velocity 介绍</span><span class="pl__date">Sep 2014</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2014/09/30/ssh-config.html"><span class="pl__circle"></span><span class="pl__title">ssh_config 占位符</span><span class="pl__date">Sep 2014</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2014/09/30/delete-dom-header.html"><span class="pl__circle"></span><span class="pl__title">DOM头惹的祸</span><span class="pl__date">Sep 2014</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2014/08/05/php55-trait.html"><span class="pl__circle"></span><span class="pl__title">php5.5 新特性</span><span class="pl__date">Aug 2014</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2014/08/05/php54-trait.html"><span class="pl__circle"></span><span class="pl__title">php5.4 新特性</span><span class="pl__date">Aug 2014</span></a>
        
          <a class="前端 pl__all" href="/%E5%89%8D%E7%AB%AF/2014/07/16/angularjs-cart.html"><span class="pl__circle"></span><span class="pl__title">AngularJS 购物车</span><span class="pl__date">Jul 2014</span></a>
        
          <a class="前端 pl__all" href="/%E5%89%8D%E7%AB%AF/2014/07/16/angularjs-helloworld.html"><span class="pl__circle"></span><span class="pl__title">AngularJS 初探</span><span class="pl__date">Jul 2014</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2014/06/10/fpm-used-all-process.html"><span class="pl__circle"></span><span class="pl__title">fpm的所有进程都占用 出现假死</span><span class="pl__date">Jun 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/06/07/mac-android-mobile.html"><span class="pl__circle"></span><span class="pl__title">mac 下识别android手机</span><span class="pl__date">Jun 2014</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2014/05/29/generate-short-link.html"><span class="pl__circle"></span><span class="pl__title">生成短链接</span><span class="pl__date">May 2014</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2014/05/22/hive-load-nginx-log.html"><span class="pl__circle"></span><span class="pl__title">hive 读取nginx 日志</span><span class="pl__date">May 2014</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2014/04/23/fuzzy-image.html"><span class="pl__circle"></span><span class="pl__title">图像的模糊处理</span><span class="pl__date">Apr 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/02/05/ios-bezier-curves.html"><span class="pl__circle"></span><span class="pl__title">ios 用关键帧按贝塞尔曲线移动</span><span class="pl__date">Feb 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/01/27/ios-third-share.html"><span class="pl__circle"></span><span class="pl__title">ios 第三方库大汇总</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/01/27/ios-static-lib.html"><span class="pl__circle"></span><span class="pl__title">ios 静态库</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/01/27/calayer-example.html"><span class="pl__circle"></span><span class="pl__title">CALayer 常用例子</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/01/27/uitableview-3.html"><span class="pl__circle"></span><span class="pl__title">uitableview (3)</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2014/01/26/select-for-update.html"><span class="pl__circle"></span><span class="pl__title">select for update</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/01/26/uitableview-2.html"><span class="pl__circle"></span><span class="pl__title">UITableView (2)</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/01/24/uitableview-1.html"><span class="pl__circle"></span><span class="pl__title">UITableView (1)</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="移动 pl__all" href="/%E7%A7%BB%E5%8A%A8/2014/01/22/ios-code-helloworld.html"><span class="pl__circle"></span><span class="pl__title">纯代码写ios</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="前端 pl__all" href="/%E5%89%8D%E7%AB%AF/2013/07/25/304huan-cun-tu-pian-mei-you-hong-fa-loadshi-jian.html"><span class="pl__circle"></span><span class="pl__title">304缓存图片没有触发load事件</span><span class="pl__date">Jul 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/07/18/ubuntu-keychain-shi-yong.html"><span class="pl__circle"></span><span class="pl__title">ubuntu keychain 使用</span><span class="pl__date">Jul 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/07/17/linux-cao-zuo-ji-jin.html"><span class="pl__circle"></span><span class="pl__title">linux 操作集锦</span><span class="pl__date">Jul 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/07/17/mmd-backend.html"><span class="pl__circle"></span><span class="pl__title">创业公司的运维工作</span><span class="pl__date">Jul 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/07/15/cutycapt-htmlye-mian-sheng-cheng-tu-pian-fen-xiang-wei-bo.html"><span class="pl__circle"></span><span class="pl__title">CutyCapt html页面生成图片 分享微博</span><span class="pl__date">Jul 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/07/02/phptu-pian-chu-li-ubuntupei-zhi.html"><span class="pl__circle"></span><span class="pl__title">php图片处理ubuntu配置</span><span class="pl__date">Jul 2013</span></a>
        
          <a class="前端 pl__all" href="/%E5%89%8D%E7%AB%AF/2013/06/27/fu-dong-ju-zhong.html"><span class="pl__circle"></span><span class="pl__title">浮动居中</span><span class="pl__date">Jun 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/05/30/sshfs.html"><span class="pl__circle"></span><span class="pl__title">sshfs</span><span class="pl__date">May 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/05/29/cacti-spinede-an-zhuang-pei-zhi.html"><span class="pl__circle"></span><span class="pl__title">cacti spine的安装配置</span><span class="pl__date">May 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/05/29/sysdescr-unknown-object-identifier-sub-id-not-found-top-sysdescr.html"><span class="pl__circle"></span><span class="pl__title">解决 sysDescr: Unknown Object Identifier (Sub-id not found: (top)  sysDescr)</span><span class="pl__date">May 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/05/24/sqlalchemy-ding-yi-mo-xing.html"><span class="pl__circle"></span><span class="pl__title">sqlalchemy 定义模型</span><span class="pl__date">May 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/05/24/yii-yin-cang-index-dot-php.html"><span class="pl__circle"></span><span class="pl__title">yii 隐藏index.php RESTful nginx配置</span><span class="pl__date">May 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/05/24/yii-yong-hu-yan-zheng.html"><span class="pl__circle"></span><span class="pl__title">yii 用户验证</span><span class="pl__date">May 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/05/23/yii-ri-zhi.html"><span class="pl__circle"></span><span class="pl__title">yii 文件日志</span><span class="pl__date">May 2013</span></a>
        
          <a class="前端 pl__all" href="/%E5%89%8D%E7%AB%AF/2013/05/23/jquery-validation.html"><span class="pl__circle"></span><span class="pl__title">jquery validation</span><span class="pl__date">May 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/05/02/ying-wen-ubuntuan-zhuang-zhong-wen-bao.html"><span class="pl__circle"></span><span class="pl__title">英文Ubuntu安装中文包</span><span class="pl__date">May 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/04/07/zhu-cong-qie-huan.html"><span class="pl__circle"></span><span class="pl__title">主从切换</span><span class="pl__date">Apr 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/04/07/ke-long-slave.html"><span class="pl__circle"></span><span class="pl__title">克隆 slave</span><span class="pl__date">Apr 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/04/04/5fen-zhong-li-jie-iptables.html"><span class="pl__circle"></span><span class="pl__title">5分钟理解iptables</span><span class="pl__date">Apr 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/04/03/ubuntu-routeming-ling.html"><span class="pl__circle"></span><span class="pl__title">ubuntu route命令</span><span class="pl__date">Apr 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/04/03/tcpdump-jian-ming-jiao-cheng.html"><span class="pl__circle"></span><span class="pl__title">tcpdump 简明教程</span><span class="pl__date">Apr 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/04/03/ibm-x3650-zhong-zhuang-xi-tong.html"><span class="pl__circle"></span><span class="pl__title">ibm x3650 重装系统</span><span class="pl__date">Apr 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/04/03/fu-wu-qi-zeng-jia-ci-pan.html"><span class="pl__circle"></span><span class="pl__title">ubuntu服务器增加磁盘</span><span class="pl__date">Apr 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/03/31/nginx-pei-zhi-mo-ban.html"><span class="pl__circle"></span><span class="pl__title">nginx 配置模板</span><span class="pl__date">Mar 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/03/27/ubuntu-xiu-fu-localecuo-wu.html"><span class="pl__circle"></span><span class="pl__title">ubuntu 修复locale错误</span><span class="pl__date">Mar 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/03/05/sqlalchemy-zi-dong-chuang-jian-biao.html"><span class="pl__circle"></span><span class="pl__title">sqlalchemy 自动创建表</span><span class="pl__date">Mar 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/02/27/mysql-an-quan.html"><span class="pl__circle"></span><span class="pl__title">Mysql 安全</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/02/27/mysql-guan-li-yu-ju.html"><span class="pl__circle"></span><span class="pl__title">Mysql 管理语句</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/02/27/mysql-zhuang-tai-jian-cha.html"><span class="pl__circle"></span><span class="pl__title">Mysql 状态检查</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/02/27/mysql-zhu-cong-she-zhi.html"><span class="pl__circle"></span><span class="pl__title">Mysql 主从设置</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/02/27/mysql-you-hua-pei-zhi.html"><span class="pl__circle"></span><span class="pl__title">Mysql 优化配置</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2013/02/27/mysql-ri-zhi-fen-lei.html"><span class="pl__circle"></span><span class="pl__title">Mysql 日志分类</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/02/26/ubuntu-wang-luo-she-zhi.html"><span class="pl__circle"></span><span class="pl__title">ubuntu 网络设置</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/02/26/fu-wu-qi-ji-chu-pei-zhi.html"><span class="pl__circle"></span><span class="pl__title">ubuntu 服务器基础配置</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/02/01/flask-nginx-uwsgibu-shu.html"><span class="pl__circle"></span><span class="pl__title">flask nginx uwsgi 部署</span><span class="pl__date">Feb 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/01/18/you-lan-qi-huan-cun-jie-xi.html"><span class="pl__circle"></span><span class="pl__title">游览器缓存解析</span><span class="pl__date">Jan 2013</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2013/01/10/rtxldapjiao-cheng.html"><span class="pl__circle"></span><span class="pl__title">RTXLDAP教程</span><span class="pl__date">Jan 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2013/01/06/datehan-shu-de-wu-yong.html"><span class="pl__circle"></span><span class="pl__title">date函数的误用</span><span class="pl__date">Jan 2013</span></a>
        
          <a class="前端 pl__all" href="/%E5%89%8D%E7%AB%AF/2013/01/04/jqueryzai-firefoxxia-wu-fa-autocomplete.html"><span class="pl__circle"></span><span class="pl__title">jquery在firefox下无法autocomplete</span><span class="pl__date">Jan 2013</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/12/17/system-dot-out-dot-printlnluan-ma.html"><span class="pl__circle"></span><span class="pl__title">System.out.println 乱码</span><span class="pl__date">Dec 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/25/mogilefsshe-bei-sun-pi-chu-li-liu-cheng.html"><span class="pl__circle"></span><span class="pl__title">mogilefs设备损坏处理流程</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/25/inotify.html"><span class="pl__circle"></span><span class="pl__title">inotify,rsync统一化配置</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/22/mogilefsan-zhuang-pei-zhi.html"><span class="pl__circle"></span><span class="pl__title">MogileFS安装配置</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/22/time-hiresjie-shao.html"><span class="pl__circle"></span><span class="pl__title">Time::HiRes介绍</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="数据存储 pl__all" href="/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/2012/11/22/redisshi-zhan.html"><span class="pl__circle"></span><span class="pl__title">redis实战</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/22/xiu-fu-mogilefsmu-lu-owner.html"><span class="pl__circle"></span><span class="pl__title">修复mogilefs目录owner</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/10/an-zhuang-pei-zhi-hive.html"><span class="pl__circle"></span><span class="pl__title">安装配置hive</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/08/perlfu-jin-cheng-jian-ting-zi-jin-cheng-gong-zuo-shi-li.html"><span class="pl__circle"></span><span class="pl__title">perl父进程监听，子进程工作实例</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/11/07/nginxfan-xiang-dai-li-zi-dong-urldecodewen-ti.html"><span class="pl__circle"></span><span class="pl__title">nginx反向代理自动urldecode问题</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/06/mogilefsshan-chu-dui-lie.html"><span class="pl__circle"></span><span class="pl__title">mogilefs删除队列</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/04/bian-xie-hadoopde-map-reduce.html"><span class="pl__circle"></span><span class="pl__title">编写hadoop的Map-Reduce</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/03/eclipsepei-zhi-hadoopde-map-reducekai-fa-huan-jing.html"><span class="pl__circle"></span><span class="pl__title">eclipse配置hadoop的map-reduce开发环境</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/11/02/an-zhuang-pei-zhi-hadoop.html"><span class="pl__circle"></span><span class="pl__title">安装配置hadoop</span><span class="pl__date">Nov 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/10/23/mogilefsxiang-jie.html"><span class="pl__circle"></span><span class="pl__title">MogileFS详解</span><span class="pl__date">Oct 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/10/16/mogilefsde-replicatefen-xi.html"><span class="pl__circle"></span><span class="pl__title">MogileFS的replicate进程分析</span><span class="pl__date">Oct 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/10/14/ying-pan-an-zhuang-centos.html"><span class="pl__circle"></span><span class="pl__title">硬盘安装CentOS</span><span class="pl__date">Oct 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/10/13/irc-irssishi-yong-jiao-cheng.html"><span class="pl__circle"></span><span class="pl__title">IRC:irssi使用教程</span><span class="pl__date">Oct 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/10/13/mogstoredshi-yong-nginx.html"><span class="pl__circle"></span><span class="pl__title">mogstored使用nginx</span><span class="pl__date">Oct 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/10/11/mogilefswen-jian-lu-jing-gui-ze.html"><span class="pl__circle"></span><span class="pl__title">mogilefs文件路径规则</span><span class="pl__date">Oct 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/10/09/mogilefsshe-bei-quan-zhong-suan-fa.html"><span class="pl__circle"></span><span class="pl__title">mogilefs设备权重算法</span><span class="pl__date">Oct 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/29/mogilefsde-fscktan-jiu.html"><span class="pl__circle"></span><span class="pl__title">mogilefs fsck探究</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/27/aho-corasicksuan-fa.html"><span class="pl__circle"></span><span class="pl__title">Aho-Corasick算法</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/27/solrsheng-lue-ri-zhi.html"><span class="pl__circle"></span><span class="pl__title">显示solr省略的日志</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/21/solrde-shu-zhi-cun-chu-he-fan-wei-cha-xun.html"><span class="pl__circle"></span><span class="pl__title">solr的数值存储和范围查询</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/20/shi-yong-jmxfen-xi-solrzhuang-tai.html"><span class="pl__circle"></span><span class="pl__title">使用JMX分析solr状态</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/18/xiang-liang-kong-jian-mo-xing.html"><span class="pl__circle"></span><span class="pl__title">向量空间模型</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/14/solrman-cha-xun-fen-xi.html"><span class="pl__circle"></span><span class="pl__title">solr慢查询分析</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/09/07/lucene-ru-men.html"><span class="pl__circle"></span><span class="pl__title">lucene 入门</span><span class="pl__date">Sep 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/08/30/chang-yong-ming-ling.html"><span class="pl__circle"></span><span class="pl__title">常用命令</span><span class="pl__date">Aug 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/08/29/solrcha-xun-guo-cheng.html"><span class="pl__circle"></span><span class="pl__title">solr查询过程</span><span class="pl__date">Aug 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/08/28/solrqi-dong-fen-xi.html"><span class="pl__circle"></span><span class="pl__title">solr启动分析</span><span class="pl__date">Aug 2012</span></a>
        
          <a class="前端 pl__all" href="/%E5%89%8D%E7%AB%AF/2012/08/24/jsmian-xiang-dui-xiang-shi-li.html"><span class="pl__circle"></span><span class="pl__title">js面向对象实例</span><span class="pl__date">Aug 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/08/16/xian-cheng-chi.html"><span class="pl__circle"></span><span class="pl__title">线程池</span><span class="pl__date">Aug 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/08/08/vimsu-ji-biao.html"><span class="pl__circle"></span><span class="pl__title">vim速记表</span><span class="pl__date">Aug 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/08/01/weakhashmapzuo-yong-he-shi-li.html"><span class="pl__circle"></span><span class="pl__title">WeakHashMap作用和实例</span><span class="pl__date">Aug 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/07/27/java-volatileli-jie.html"><span class="pl__circle"></span><span class="pl__title">java volatile理解</span><span class="pl__date">Jul 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/07/26/xdebug-500cuo-wu-xian-shi-200cheng-gong-de-bug.html"><span class="pl__circle"></span><span class="pl__title">xdebug:500错误显示200成功的bug</span><span class="pl__date">Jul 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/07/22/python-zhou-ti-yan-ji.html"><span class="pl__circle"></span><span class="pl__title">python 一周体验记</span><span class="pl__date">Jul 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/07/13/oauth-jie-shao.html"><span class="pl__circle"></span><span class="pl__title">OAuth 介绍</span><span class="pl__date">Jul 2012</span></a>
        
          <a class="系统 pl__all" href="/%E7%B3%BB%E7%BB%9F/2012/07/07/octopress-introduce.html"><span class="pl__circle"></span><span class="pl__title">octopress 介绍</span><span class="pl__date">Jul 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2012/07/06/perl-ipc.html"><span class="pl__circle"></span><span class="pl__title">进程间通信【IPC】</span><span class="pl__date">Jul 2012</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2011/07/03/perl-epoll.html"><span class="pl__circle"></span><span class="pl__title">Perl使用Epoll优化</span><span class="pl__date">Jul 2011</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2011/07/03/Mogilefs-ReadFile.html"><span class="pl__circle"></span><span class="pl__title">MogileFS读取文件的过程</span><span class="pl__date">Jul 2011</span></a>
        
          <a class="后端 pl__all" href="/%E5%90%8E%E7%AB%AF/2011/07/03/Mogilefs-Init.html"><span class="pl__circle"></span><span class="pl__title">MogileFS启动流程</span><span class="pl__date">Jul 2011</span></a>
        
        </nav>
      </div> <!-- end #posts-list -->
    </aside> <!-- end #sidebar -->

    <div id="post">
      <div id="pjax">
        <article id="post__content">
  <h1 id="post__title" data-identifier="20120929">mogilefs fsck探究</h1>
  <h3 id="fsck">fsck的作用</h3>
<ul>
  <li>检查mogilefs文件的健康程度，检查的维度有devcount,file_on表,文件长度，校验和（可选）</li>
  <li>如果文件丢失，通过路径尝试全设备扫描去查找该文件【只是通过路径去找】</li>
</ul>

<h3 id="fsck-1">使用fsck时，碰到的问题:队列保持不变，无法处理后续的文件</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">//启动fsck
mogadm fsck start  
//查看fsck状态，问题出现：进度不变,无法进一步检查文件
mogadm fsck status 
//查看数据库里的队列，发现队列一直保持，没有被处理
<span class="k">select</span> count<span class="o">(</span>*<span class="o">)</span> from file_to_queue where <span class="nb">type</span><span class="o">=</span><span class="m">1</span> （type<span class="o">=</span>1代表fsck队列，type<span class="o">=</span>2代表rebalance队列）<span class="p">;</span></code></pre></div>

<h3 id="section">结论（先给出结论，后面有具体的分析流程）</h3>
<ul>
  <li>随意取得队列中的某一条记录的devcount等于3，过去操作造成的</li>
  <li>mindevcount却等于2，这会让fsck进行修复</li>
  <li>在修复时，发现3个设备中有一个设备是不可达的，状态也不是dead，返回无法处理，fsck不会把该记录从队列中删除，因为他期望你尽快修复该设备或者设置为dead</li>
  <li>解决方法有3个，第一种就是恢复或dead该设备【推荐】，第二种比较山寨,改代码删队列，第三种直接修改数据库,风险较大</li>
</ul>

<h3 id="mogadm-fsck-status">mogadm fsck status详情</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Running: 运行状态 
    Status: 完成度
      Time: 执行时间
Check Type: 检查的策略【可以通过fsck_opt_policy_only修改】

NOPA: file_on表里一个都没
POVI: 违反策略
MISS: 在某个设备上没有找到文件
BLEN: file表里的length和磁盘上的文件大小不匹配
GONE: 无法修复了
SRCH: 开始全设备扫描
FOND: 全设备扫描后找了该文件
REPL: 加入复制队列，复制一份文件
BCNT: file表里的devcount不正确</code></pre></div>

<!-- more -->
<p>###MogileFS::Worker::Fsck的work方法分析
+ 因为之前有分析过MogileFS启动源码，所以知道fsck子进程启动就调用MogileFS::Worker::Fsck里的work方法
+ 里面循环调用了最关键的check_fid方法来检查fid对象，返回的结果是已经处理（HANDLED）和没办法处理（STALLED）</p>

<div class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="k">sub </span><span class="nf">work</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="c1">#perl面向对象获取自己的引用</span>
    <span class="nn">POSIX::</span><span class="n">nice</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  <span class="c1">#调整进程的优先级</span>

    <span class="k">my</span> <span class="nv">$sto</span>         <span class="o">=</span> <span class="nn">Mgd::</span><span class="n">get_store</span><span class="p">();</span> <span class="c1">#获取操作数据库的对象</span>
    
    <span class="c1">#2秒调用一次这个匿名方法</span>
    <span class="n">every</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="nv">$sleep_set</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="c1">#一个调整sleep时间的函数，下面可以看到设置为0不去调整，就用2秒</span>
        <span class="nv">$nowish</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>      <span class="c1">#当前时间</span>
        <span class="nb">local</span> <span class="nv">$</span><span class="nn">Mgd::</span><span class="nv">nowish</span> <span class="o">=</span> <span class="nv">$nowish</span><span class="p">;</span> <span class="c1">#零时变量</span>

        <span class="k">my</span> <span class="nv">$queue_todo</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">queue_todo</span><span class="p">(</span><span class="s">&#39;fsck&#39;</span><span class="p">);</span>    <span class="c1">#获取fsck队列里的数据</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">send_to_parent</span><span class="p">(</span><span class="s">&#39;worker_bored 50 fsck&#39;</span><span class="p">);</span> <span class="c1">#告诉父进程，我还活着</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$queue_todo</span><span class="p">};</span>                  <span class="c1">#没有需要需要处理就返回</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">validate_dbh</span><span class="p">;</span>             <span class="c1">#验证db，无法连接就退出</span>

        <span class="k">my</span> <span class="nv">@fids</span> <span class="o">=</span> <span class="p">();</span>  <span class="c1">#fids数组，用来存放文件的id,也是数据库里文件的唯一标识 </span>
        <span class="c1">#遍历队列的数据，$todo就是数据库里的信息 type=1</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$todo</span> <span class="o">=</span> <span class="nb">shift</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$queue_todo</span><span class="p">})</span> <span class="p">{</span>        
            <span class="c1">#new 一个fid对象，只是new，还没有读取fid信息</span>
            <span class="k">my</span> <span class="nv">$fid</span> <span class="o">=</span> <span class="nn">MogileFS::</span><span class="n">FID</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$todo</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">fid</span><span class="p">});</span>  
            <span class="c1">#这里才是通过查file表，判断他是不是存在</span>
            <span class="k">unless</span> <span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="nb">exists</span><span class="p">)</span> <span class="p">{</span>                      
                <span class="c1">#从file_to_queue表里删除</span>
                <span class="nv">$sto</span><span class="o">-&gt;</span><span class="n">delete_fid_from_file_to_queue</span><span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">FSCK_QUEUE</span><span class="p">);</span> 
            <span class="p">}</span>
            <span class="nb">push</span><span class="p">(</span><span class="nv">@fids</span><span class="p">,</span> <span class="nv">$fid</span><span class="p">);</span> <span class="c1">#如果有，那就把fid对象放到数组里</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="nv">@fids</span><span class="p">;</span>   <span class="c1">#如果没有需要处理的就返回了 </span>
        <span class="c1">#从setting表里读取fsck_opt_policy_only配置</span>
        <span class="c1">#1代表只检查数据库信息，0代表检查数据信息和文件长度</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_nostat</span><span class="p">}</span> <span class="o">=</span> <span class="nn">MogileFS::</span><span class="n">Config</span><span class="o">-&gt;</span><span class="n">server_setting</span><span class="p">(</span><span class="s">&#39;fsck_opt_policy_only&#39;</span><span class="p">)</span>     <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="c1">#从setting表里读取fsck_checksum配置,代表是否需要检查校验和,可选值为md5,sha-1,off</span>
        <span class="k">my</span> <span class="nv">$alg</span> <span class="o">=</span> <span class="nn">MogileFS::</span><span class="n">Config</span><span class="o">-&gt;</span><span class="n">server_setting_cached</span><span class="p">(</span><span class="s">&quot;fsck_checksum&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$alg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$alg</span> <span class="ow">eq</span> <span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">#如果没有定义或为off</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_checksum</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;off&quot;</span><span class="p">;</span>      <span class="c1">#那就设置成off,不检查</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">#验证一下是否为md5 或 sha-1,如果不是那就设置为0</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_checksum</span><span class="p">}</span> <span class="o">=</span> <span class="nn">MogileFS::</span><span class="n">Checksum</span><span class="o">-&gt;</span><span class="n">valid_alg</span><span class="p">(</span><span class="nv">$alg</span><span class="p">)</span> <span class="p">?</span> <span class="nv">$alg</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nn">MogileFS::</span><span class="n">FID</span><span class="o">-&gt;</span><span class="n">mass_load_devids</span><span class="p">(</span><span class="nv">@fids</span><span class="p">);</span> <span class="c1">#通过file_on表获取每个fid存放在哪些device上</span>
        <span class="nv">$sleep_set</span><span class="o">-&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">#微调sleep时间，写死为0，可能是调试用的</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$fid</span> <span class="p">(</span><span class="nv">@fids</span><span class="p">)</span> <span class="p">{</span>               <span class="c1">#循环每一个fid对象</span>
            <span class="c1">#这里是关键是亮点，是接下去分析的入口</span>
            <span class="c1">#返回的结果是已经处理（HANDLED）和没办法处理（STALLED）</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="n">check_fid</span><span class="p">(</span><span class="nv">$fid</span><span class="p">))</span> <span class="p">{</span>      
                <span class="c1">#如果运行到了这里，说明跟磁盘有连通性的问题</span>
                <span class="c1">#最重要的是不会删除队列，放在里面以后再尝试</span>
                <span class="c1">#其实队列的卡住的问题就出在这里,接下去进入check_fid看看</span>
                <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">still_alive</span><span class="p">;</span>
                <span class="k">next</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">#已经处理了，就可以删除队列里的数据了</span>
            <span class="nv">$sto</span><span class="o">-&gt;</span><span class="n">delete_fid_from_file_to_queue</span><span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">FSCK_QUEUE</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></div>

<h3 id="mogilefsworkerfsckcheckfid">MogileFS::Worker::Fsck的check_fid方法分析</h3>
<ul>
  <li>传入的参数是$fid是MogileFS::FID对象</li>
  <li>返回0表示磁盘不可达（STALLED）</li>
  <li>返回1代表fid对象已经被处理，不管这个fid是不是有问题，没问题就不处理，有问题就记录日志并修复</li>
  <li>真正去修复一个fid对象的函数是fix_fid,接下去会分析</li>
  <li>问题渐渐浮出水面，坏掉的设备没有被dead，或者直接删除掉设备有可能会让队列卡住</li>
</ul>

<div class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="c1">#下面是返回值，被定义成常量</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">STALLED</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HANDLED</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">check_fid</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$fid</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>      <span class="c1">#设置对象自己和fid对象</span>

    <span class="k">my</span> <span class="nv">$fix</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span>             <span class="c1">#定义一个修复的数据的函数,只是定义，真正的调用在下面逻辑</span>
        <span class="c1">#fix_fid是最重要的函数用来修复fid对象，也是接下去需要分析的入口</span>
        <span class="c1">#这里使用了eval{}，这样可以捕获错误</span>
        <span class="k">my</span> <span class="nv">$fixed</span> <span class="o">=</span> <span class="nb">eval</span> <span class="p">{</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">fix_fid</span><span class="p">(</span><span class="nv">$fid</span><span class="p">)</span> <span class="p">};</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">defined</span> <span class="nv">$fixed</span><span class="p">)</span> <span class="p">{</span>                     <span class="c1">#如果产生了错误</span>
            <span class="c1">#输出异常日志，我们的问题就会运行到这里输出这样的信息</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&quot;Fsck stalled for fid $fid: $@&quot;</span><span class="p">);</span> 
            <span class="c1">#返回一个不会去删除队列的结果，造成队列积满</span>
            <span class="c1">#所以直接去fix_fid里查看错误的判断就可以知道为什么了</span>
            <span class="k">return</span> <span class="n">STALLED</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_CANT_FIX</span><span class="p">)</span> <span class="k">if</span> <span class="o">!</span> <span class="nv">$fixed</span><span class="p">;</span>  <span class="c1">#记录日志，不可以修复,GONE</span>
        <span class="nv">$nowish</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">still_alive</span><span class="p">;</span>             <span class="c1">#更新时间</span>
        <span class="k">return</span> <span class="n">HANDLED</span><span class="p">;</span>                           <span class="c1">#返回已经处理</span>
    <span class="p">};</span>
    
    <span class="k">unless</span> <span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devids</span><span class="p">)</span> <span class="p">{</span>         <span class="c1">#一个设备上都没有的话</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_NO_PATHS</span><span class="p">);</span><span class="c1">#记录日志path都没 NOPA</span>
        <span class="k">return</span> <span class="nv">$fix</span><span class="o">-&gt;</span><span class="p">();</span>            <span class="c1">#搜索所有设备作为最后的努力来定位它</span>
    <span class="p">}</span>
    <span class="c1">#查找数据库file_on数量，要满足mindevcount，如果超过也属于不满足（神奇的too happy）</span>
    <span class="k">unless</span> <span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devids_meet_policy</span><span class="p">)</span> <span class="p">{</span>     
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_POLICY_VIOLATION</span><span class="p">);</span><span class="c1">#记录日志违反策略 POVI</span>
        <span class="k">return</span> <span class="nv">$fix</span><span class="o">-&gt;</span><span class="p">();</span>                    <span class="c1">#尝试修复</span>
    <span class="p">}</span>

    <span class="c1">#如果不skip_devcount，同时file_on和file里的devcount对不起来</span>
    <span class="k">unless</span> <span class="p">(</span><span class="nn">MogileFS::</span><span class="n">Config</span><span class="o">-&gt;</span><span class="n">server_setting_cached</span><span class="p">(</span><span class="s">&#39;skip_devcount&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">scalar</span><span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devids</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devcount</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_BAD_COUNT</span><span class="p">);</span> <span class="c1">#记录日志file表里devcount不正确</span>
        <span class="k">return</span> <span class="nv">$fix</span><span class="o">-&gt;</span><span class="p">();</span>              <span class="c1">#尝试修复，其实是调用$fid-&gt;update_devcount();</span>
    <span class="p">}</span>

    <span class="c1">#我们不使用，其实他是判断checksum表里是否有记录</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">hashtype</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">return</span> <span class="nv">$fix</span><span class="o">-&gt;</span><span class="p">();</span>        <span class="c1">#尝试修复</span>
    <span class="p">}</span>

    <span class="c1">#如果配置了fsck_opt_policy_only那就到此结束了,不会去判断文件长度和校验和了</span>
    <span class="c1">#如果策略是这样，事故后的fsck就有意义了</span>
    <span class="k">return</span> <span class="n">HANDLED</span> <span class="k">if</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_nostat</span><span class="p">};</span> 
    <span class="c1">#如果配置检查校验和,默认不使用</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_checksum</span><span class="p">}</span> <span class="o">&amp;&amp;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_checksum</span><span class="p">}</span> <span class="ow">ne</span> <span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">return</span> <span class="nv">$fix</span><span class="o">-&gt;</span><span class="p">();</span> <span class="c1">#尝试修复</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$err</span><span class="p">;</span> <span class="c1">#记录错误的变量</span>
    <span class="c1">#parallel_check_sizes会取得磁盘上文件的大小</span>
    <span class="c1">#匿名的对比函数,第一个参数是设备,第二参数就是磁盘上文件的大小</span>
    <span class="k">my</span> <span class="nv">$rv</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">parallel_check_sizes</span><span class="p">([</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devfids</span> <span class="p">],</span> <span class="k">sub </span><span class="p">{</span>
        <span class="k">my</span> <span class="p">(</span><span class="nv">$dfid</span><span class="p">,</span> <span class="nv">$disk_size</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>            <span class="c1">#devfid对象，和磁盘上文件的大小</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">defined</span> <span class="nv">$disk_size</span><span class="p">)</span> <span class="p">{</span>             <span class="c1">#如果拿不到磁盘上文件的大小</span>
            <span class="k">my</span> <span class="nv">$dev</span>  <span class="o">=</span> <span class="nv">$dfid</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>           <span class="c1">#设备对象</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$dev</span><span class="o">-&gt;</span><span class="n">dstate</span><span class="o">-&gt;</span><span class="n">is_perm_dead</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">#如果磁盘的状态是dead</span>
                <span class="nv">$err</span> <span class="o">=</span> <span class="s">&quot;needfix&quot;</span><span class="p">;</span>               <span class="c1">#记录错误为需要修复</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                       <span class="c1">#返回0</span>
            <span class="p">}</span>
            <span class="c1">#输出连通性问题的日志</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&quot;Connectivity problem reaching device &quot;</span> <span class="o">.</span> <span class="nv">$dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">.</span> <span class="s">&quot; on host &quot;</span> <span class="o">.</span> <span class="nv">$dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">);</span>
            <span class="nv">$err</span> <span class="o">=</span> <span class="s">&quot;stalled&quot;</span><span class="p">;</span>                   <span class="c1">#记录错误为无法处理</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                           <span class="c1">#返回0</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="nv">$disk_size</span> <span class="o">==</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="nb">length</span><span class="p">;</span> <span class="c1">#file表里的length和磁盘上的大小一样,直接返回1</span>
        <span class="nv">$err</span> <span class="o">=</span> <span class="s">&quot;needfix&quot;</span><span class="p">;</span>                       <span class="c1">#下面就是大小不一样了，记录错误为需要修复</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                               <span class="c1">#返回0</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$rv</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">hashtype</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_checksum</span><span class="p">}</span> <span class="o">&amp;&amp;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">opt_checksum</span><span class="p">}</span> <span class="ow">eq</span> <span class="s">&quot;off&quot;</span><span class="p">))</span>
            <span class="p">?</span> <span class="nv">$fix</span><span class="o">-&gt;</span><span class="p">()</span> <span class="p">:</span> <span class="n">HANDLED</span><span class="p">;</span>               <span class="c1">#不扯校验和了，直接返回已处理</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$err</span> <span class="ow">eq</span> <span class="s">&quot;stalled&quot;</span><span class="p">)</span> <span class="p">{</span>               
        <span class="c1">#返回无法处理，也会造成队列堆积，因为file_on表里的device没有设置为dead</span>
        <span class="k">return</span> <span class="n">STALLED</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$err</span> <span class="ow">eq</span> <span class="s">&quot;needfix&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">#进行修复</span>
        <span class="k">return</span> <span class="nv">$fix</span><span class="o">-&gt;</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">#这里应该不会执行到</span>
        <span class="nb">die</span> <span class="s">&quot;Unknown error checking fid sizes in parallel.\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<h3 id="mogilefsworkerfsckfixfid">MogileFS::Worker::Fsck的fix_fid方法分析</h3>
<ul>
  <li>该方法有可能会比较慢，因为file_on表上一条记录都没会尝试查找所有设备，【通过path】</li>
  <li>die是由于设备连接性问题造成的，会引起队列堵死</li>
</ul>

<div class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="k">use</span> <span class="n">constant</span> <span class="n">CANT_FIX</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">#不可以被修复</span>
<span class="k">sub </span><span class="nf">fix_fid</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$fid</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>                     <span class="c1">#对象自己，fid对象</span>
    <span class="n">debug</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&quot;Fixing FID %d&quot;</span><span class="p">,</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span> <span class="c1">#调试信息，正在修复哪个fid</span>

    <span class="c1">#通过file_on更新一下file表里的devcount; </span>
    <span class="c1">#这里学习了下mysql的get_lock</span>
    <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">update_devcount</span><span class="p">;</span>

    <span class="c1">#遍历devids属性生成多个devfid对象放到数组,其实就是file_on表</span>
    <span class="k">my</span> <span class="nv">@dfids</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span> <span class="nn">MogileFS::</span><span class="n">DevFID</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$_</span><span class="p">,</span> <span class="nv">$fid</span><span class="p">)</span> <span class="p">}</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devids</span><span class="p">;</span> 

    <span class="k">my</span> <span class="nv">@good_devs</span><span class="p">;</span>        <span class="c1">#初始化好的设备</span>
    <span class="k">my</span> <span class="nv">@bad_devs</span><span class="p">;</span>         <span class="c1">#初始化坏的设备数组</span>
    <span class="k">my</span> <span class="nv">%already_checked</span><span class="p">;</span>  <span class="c1">#初始化已经检查过的设备hash</span>

    <span class="k">my</span> <span class="nv">$check_dfids</span> <span class="o">=</span> <span class="k">sub </span><span class="p">{</span> <span class="c1">#定义一个监测函数</span>
        <span class="k">my</span> <span class="nv">$is_desperate_mode</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="c1">#是否全设备扫描</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$dfid</span> <span class="p">(</span><span class="nv">@dfids</span><span class="p">)</span> <span class="p">{</span> <span class="c1">#遍历fid的devfid对象</span>
            <span class="k">my</span> <span class="nv">$dev</span> <span class="o">=</span> <span class="nv">$dfid</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
            <span class="k">next</span> <span class="k">if</span> <span class="nv">$already_checked</span><span class="p">{</span><span class="nv">$dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">}</span><span class="o">++</span><span class="p">;</span> <span class="c1">#已经检查过就跳过了</span>

            <span class="c1">#磁盘状态为dead，那就放到bad_devs里</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$dev</span><span class="o">-&gt;</span><span class="n">dstate</span><span class="o">-&gt;</span><span class="n">is_perm_dead</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">push</span> <span class="nv">@bad_devs</span><span class="p">,</span> <span class="nv">$dev</span><span class="p">;</span>
                <span class="k">next</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="k">my</span> <span class="nv">$disk_size</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">size_on_disk</span><span class="p">(</span><span class="nv">$dfid</span><span class="p">);</span>  <span class="c1">#获取磁盘上的文件大小</span>
            <span class="c1">#这里是我们产生问题的根源。。。设备不可达，也没设置成dead</span>
            <span class="nb">die</span> <span class="s">&quot;dev &quot;</span> <span class="o">.</span> <span class="nv">$dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">.</span> <span class="s">&quot; unreachable&quot;</span> <span class="k">unless</span> <span class="nb">defined</span> <span class="nv">$disk_size</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$disk_size</span> <span class="o">==</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="nb">length</span><span class="p">)</span> <span class="p">{</span> <span class="c1">#如果长度一样</span>
                <span class="nb">push</span> <span class="nv">@good_devs</span><span class="p">,</span> <span class="nv">$dfid</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span> <span class="c1">#加到好的设备里</span>
                <span class="c1">#如果是全设备扫描，那就等于发现了丢失文件，就可以返回了，不用继续查找了</span>
                <span class="k">return</span> <span class="k">if</span> <span class="nv">$is_desperate_mode</span><span class="p">;</span> 
                <span class="k">next</span><span class="p">;</span> <span class="c1">#下一个,其他编程语言的continue</span>
            <span class="p">}</span>

            <span class="k">unless</span> <span class="p">(</span><span class="nv">$is_desperate_mode</span><span class="p">)</span> <span class="p">{</span> <span class="c1">#如果不是全设备扫描</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$disk_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">#没有找到文件呀,MISS</span>
                    <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_FILE_MISSING</span><span class="p">,</span> <span class="nv">$dev</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">#长度不正确呀,BLEN</span>
                    <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_BAD_LENGTH</span><span class="p">,</span> <span class="nv">$dev</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nb">push</span> <span class="nv">@bad_devs</span><span class="p">,</span> <span class="nv">$dfid</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span> <span class="c1">#增加到坏设备里</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nv">$check_dfids</span><span class="o">-&gt;</span><span class="p">();</span> <span class="c1">#调用上面的监测函数</span>

    <span class="k">unless</span> <span class="p">(</span><span class="nv">@good_devs</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># 如果一个好的都没</span>
        <span class="c1">#记录日志,全设备扫描 SRCH</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_START_SEARCH</span><span class="p">);</span>
        <span class="c1">#重新设置@dfids,全部的设备</span>
        <span class="nv">@dfids</span> <span class="o">=</span> <span class="nn">List::Util::</span><span class="n">shuffle</span><span class="p">(</span>
                                     <span class="nb">map</span>  <span class="p">{</span> <span class="nn">MogileFS::</span><span class="n">DevFID</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$_</span><span class="p">,</span> <span class="nv">$fid</span><span class="p">)</span>  <span class="p">}</span>
                                     <span class="nb">grep</span> <span class="p">{</span> <span class="nv">$_</span><span class="o">-&gt;</span><span class="n">dstate</span><span class="o">-&gt;</span><span class="n">should_fsck_search_on</span> <span class="p">}</span>
                                     <span class="nn">Mgd::</span><span class="n">device_factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_all</span>
                                     <span class="p">);</span>
        <span class="c1">#重新再找一次,这次是全盘扫描模式</span>
        <span class="nv">$check_dfids</span><span class="o">-&gt;</span><span class="p">(</span><span class="s">&quot;desperate&quot;</span><span class="p">);</span>

        <span class="c1"># 不能修复了呀，找不到文件了</span>
        <span class="k">return</span> <span class="n">CANT_FIX</span> <span class="k">unless</span> <span class="nv">@good_devs</span><span class="p">;</span>
        <span class="c1"># 如果能找到，记录日志,FOND</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_FOUND_FID</span><span class="p">);</span>
        <span class="c1"># 加到数据库里,就是file_on的表里</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">note_on_device</span><span class="p">(</span><span class="nv">$good_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
    <span class="p">}</span>

    <span class="c1"># 循环坏的设备，删除掉file_on里的数据</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$bdev</span> <span class="p">(</span><span class="nv">@bad_devs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">error</span><span class="p">(</span><span class="s">&quot;removing file_on mapping for fid=&quot;</span> <span class="o">.</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">.</span> <span class="s">&quot;, dev=&quot;</span> <span class="o">.</span> <span class="nv">$bdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">forget_about_device</span><span class="p">(</span><span class="nv">$bdev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">want_reload</span><span class="p">;</span> <span class="c1">#重新加载fid对象</span>
    <span class="c1"># 如果还是没能满足策略，就就应该复制一份了呀</span>
    <span class="k">unless</span> <span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devids_meet_policy</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">#加入到replacte队列中</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">enqueue_for_replication</span><span class="p">(</span><span class="n">in</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">);</span>
        <span class="c1">#记录日志 REPL</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_RE_REPLICATE</span><span class="p">);</span>
        <span class="c1">#返回已经处理</span>
        <span class="k">return</span> <span class="n">HANDLED</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># 更新devcount</span>
    <span class="k">unless</span><span class="p">(</span><span class="nn">MogileFS::</span><span class="n">Config</span><span class="o">-&gt;</span><span class="n">server_setting_cached</span><span class="p">(</span><span class="s">&#39;skip_devcount&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">scalar</span><span class="p">(</span><span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devids</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">devcount</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">update_devcount</span><span class="p">();</span> 
        <span class="nv">$fid</span><span class="o">-&gt;</span><span class="n">fsck_log</span><span class="p">(</span><span class="n">EV_BAD_COUNT</span><span class="p">);</span> <span class="c1">#记录日志BCNT</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">HANDLED</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


</article> <!-- end #post__content -->

<div id="post__share">
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=http://wanghd.com/%E5%90%8E%E7%AB%AF/2012/09/29/mogilefsde-fscktan-jiu.html&text=mogilefs fsck探究" target="_blank"></a>
  <a id="icon-cc" class="fontello" href="http://creativecommons.org/licenses/by-nc-sa/3.0" target="_blank"></a>
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=http://wanghd.com/%E5%90%8E%E7%AB%AF/2012/09/29/mogilefsde-fscktan-jiu.html&title=mogilefs fsck探究" target="_blank"></a>
</div> <!-- end #post__share -->

<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'wanghdcom'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
</div> <!-- end #disqus_thread -->

<p id="copyright">Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;&nbsp;|&nbsp;&nbsp;Theme <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll</a></p>

      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">Table of Contents</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div> <!-- end #post -->

    <button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>

    <script src="/assets/js/jquery-2.0.3.min.js"></script>
    <script src="/assets/js/jquery.pjax.js"></script>
    <script src="/assets/js/nprogress.js"></script>
    <script src="/assets/js/script.js"></script>
  </body>
</html>
